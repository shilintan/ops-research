# 案例场景

下面列举了一套系统需要用到的东西

ram(账号管理)

​	key/secret

## 网络

dns (域名管理)

ssl (证书)

eip (公网IP)

slb (4层负载均衡)

nat (出口网关)

vpc (局域网)

应用防火墙

## 中间件

云mysql

云redis

云rabbitmq

云mongodb

云es

cdn (内容缓存)

oss (对象文件存储)

## 服务器

ecs

## 服务器集群

k8s

# 上线标准

## 安全性

网络环境隔离(vpn(openvpn)), ecs无外网(使用slb和nat), 外网端口绑定到专门的ecs的端口上

服务器只能使用证书文件登陆

删除默认账号, 修改默认账号密码

关闭服务的调试功能

k8s使用证书认证



使用DDOS盾和应用防火墙

静态代码扫描、依赖库cve扫描

### 维护

云账号独立到人

​	在多人重叠的情况下抽出角色

主账号不创建access key和secret, 每个服务使用专门的robot账号分配权限及创建access key和secret

## 稳定性

### 维护

使用指令

使用脚本

使用容器化、k8s

gitops

terraform

git flow机制

### 测试

代码单元测试

接口测试

集成测试

压力测试

中间件性能测试

### 部署

独立性, 不同类型服务在不同的资源池中

使用合适规格服务器

​	硬盘优于内存优于cpu, 中间件切记使用ssd

​	java服务使用跑在8c32g上

### 流量管理

队列填谷削峰

灰度环境

​	域名方式、部分用户方式

​		mq隔离

### 服务集群化

分布在多台服务器上, 至少3个副本

可下线、可扩容、可清理

自动断网、自动重启机制 (探针健康检查)

​	springboot actuator

限流机制

​	集群限流

​	节点限流

### 客户端

客户端重试、熔断、fallback(熔断推断)

### 配置

内核优化

配置文件调整为生产级别

​	关闭调试功能

​	提高连接池大小

​	jvm参数

​	提升生产级别感知, 服务注册发现

​	确定所有配置参数

​	降低额外流量影响

### 监控

前端监控状态、日志、性能、事件

采集指标, 顺着网络进行采集, 记录指标, 至少保留一个月, 对指标的饱和度(80%)和状态进行告警

​	slb, nat, ecs, k8s, k8s master, k8s woker,k8s pod

​	nginx, jvm, 中间件指标(mysql, redis, rabbitmq, es), 应用中间件指标(seata, xxljob, nacos)

采集event, event告警	

​	k8s event

记录日志文件、采集日志文件、对日志文件进行告警

采集性能, 客户端嵌入式agent, 对性能进行告警

​	nginx access log

​	java opentracing

​	mysql slowlog

​	redis slowlog

​	rabbitmq 堆积量

服务接口自动定时查询(httpGet), 告警 

#### 通知

钉钉

短信

手机号码

### 故障排查

java arthas排查包

前端 wireshark抓包

看监控

## 费用优化

对应服务使用合适的服务器规格

使用资源包而不是按量， 尽可能包年而不是包月

云厂商有优化活动(85折)时集中采购

测试环境可以放到本地环境做

### 数据管理

定期归档

​	高频存储、标准存储、冷存储、深度存储

## 技术储备

使用新技术时需要研究底层是怎么实现的, 会不会有什么问题

# 运维推进方式

轻重缓急

做急切的影响主线的

做长期重要的



核心是通过流水线减少运维工作, 通过监控减少事故, 资源隔离, 测试环境验证再上线, 新事情先使用临时方案再慢慢解决

一旦使用了就要考虑到出问题了怎么处理,  有哪里问题, 怎么暂存备份(进度)

使用稳定版本而不是latest, 使用测试过的版本而不是新的高版本, 小版本影响不大
